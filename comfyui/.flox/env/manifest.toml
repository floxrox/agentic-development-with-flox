version = 1


[install]
## comfyui
comfyui.pkg-path = "flox/comfyui"
comfyui.priority = 1
comfyui.pkg-group = "comfyui"
## comfyui add-ons | custom nodes for advanced usage
comfyui-extras.pkg-path = "flox/comfyui-extras"
comfyui-extras.priority = 2
comfyui-extras.pkg-group = "comfyui-extras"
## utilities
bat.pkg-path = "bat"
curl.pkg-path = "curl"

## custom cuda-accelerated pytorch packages | uncomment to use
#torch-cuda.pkg-path = "flox-cuda/python3Packages.torch"
#torch-cuda.systems = ["x86_64-linux", "aarch64-linux"]
#torch-cuda.priority = 1
#torch-cuda.pkg-group = "torch-cuda"

#torchvision-cuda.pkg-path = "flox-cuda/python3Packages.torchvision"
#torchvision-cuda.systems = ["x86_64-linux", "aarch64-linux"]
#torchvision-cuda.priority = 2
#torchvision-cuda.pkg-group = "torchvision-cuda"

#torchaudio-cuda.pkg-path = "flox-cuda/python3Packages.torchaudio"
#torchaudio-cuda.systems = ["x86_64-linux", "aarch64-linux"]
#torchaudio-cuda.priority = 3
#torchaudio-cuda.pkg-group = "torchvision-cuda"

## build + publish your own custom cuda-accelerated pytorch at:
## https://github.com/barstoolbluz/build-pytorch
## https://github.com/barstoolbluz/build-torchvision
## https://github.com/barstoolbluz/build-torchaudio


## cuda-acclerated python dependencies | uncomment to use
#numpy.pkg-path = "flox-cuda/python3Packages.numpy"
#numpy.systems = ["x86_64-linux"]
#numpy.priority = 3

#scipy.pkg-path = "flox-cuda/python3Packages.scipy"
#scipy.systems = ["x86_64-linux"]
#scipy.priority = 4

#scikit-image.pkg-path = "flox-cuda/python3Packages.scikit-image"
#scikit-image.systems = ["aarch64-linux", "x86_64-linux"]
#scikit-image.priority = 1

#opencv4.pkg-path = "flox-cuda/python3Packages.opencv4"
#opencv4.systems = ["x86_64-linux", "aarch64-linux"]
#opencv4.priority = 2


[vars]
# comfyui work directory (models, outputs, etc.)
COMFYUI_WORK_DIR = "$HOME/comfyui-work"

# model directories
COMFYUI_MODELS_DIR = "$HOME/comfyui-work/models"
COMFYUI_OUTPUT_DIR = "$HOME/comfyui-work/output"
COMFYUI_INPUT_DIR = "$HOME/comfyui-work/input"
COMFYUI_TEMP_DIR = "$HOME/comfyui-work/temp"

# comfyUI database | change this to whatever you like
COMFYUI_DATABASE_URL = "sqlite:///${FLOX_ENV_CACHE:-$HOME/.flox/cache}/comfyui.db"

# default comfyui server settings
COMFYUI_LISTEN = "0.0.0.0"
COMFYUI_PORT = "8188"


[hook]
on-activate = '''
  WORK_DIR="${HOME}/comfyui-work"
  mkdir -p "$WORK_DIR/models"/{checkpoints,clip,unet,vae,loras,upscale_models,controlnet,embeddings}
  mkdir -p "$WORK_DIR/output"
  mkdir -p "$WORK_DIR/input"
  mkdir -p "$WORK_DIR/temp"
  mkdir -p "$WORK_DIR/custom_nodes"
  mkdir -p "$WORK_DIR/default/workflows"

  EXTRA_PATHS_FILE="$FLOX_ENV_CACHE/extra_model_paths.yaml"
  if [ ! -f "$EXTRA_PATHS_FILE" ]; then
    cat > "$EXTRA_PATHS_FILE" <<'EOF'
comfyui:
  base_path: ~/comfyui-work/

  checkpoints: models/checkpoints/
  clip: models/clip/
  unet: models/unet/
  vae: models/vae/
  loras: models/loras/
  upscale_models: models/upscale_models/
  controlnet: models/controlnet/
  embeddings: models/embeddings/
  custom_nodes: custom_nodes/
EOF
    echo "‚úì Created extra_model_paths.yaml"
  fi

  # Fetch README.md if not present
  README_FILE="$FLOX_ENV_PROJECT/README.md"
  if [ ! -f "$README_FILE" ]; then
    if curl -fsSL https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/comfyui/README.md -o "$README_FILE" 2>/dev/null; then
      echo "‚úì Downloaded README.md (use 'helpf' to view)"
    fi
  fi

  # Welcome message
  echo ""
  echo "üé® ComfyUI Environment Ready"
  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo "  Work Dir:   ${COMFYUI_WORK_DIR}"
  echo "  Models:     ${COMFYUI_MODELS_DIR}"
  echo "  Output:     ${COMFYUI_OUTPUT_DIR}"
  echo ""
  echo "Quick Commands:"
  echo "  flox services start comfyui  ‚Üí Start ComfyUI service"
  echo "  flox services logs comfyui   ‚Üí View service logs"
  echo "  comfyui-download             ‚Üí Download AI models"
  echo "  helpf                        ‚Üí View environment documentation"
  echo ""
  echo "Models Directory Structure:"
  echo "  checkpoints/  clip/  unet/  vae/  loras/"
  echo "  upscale_models/  controlnet/  embeddings/"
  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
  echo ""
'''


[profile]

bash = '''
  # helper aliases
  alias cdwork="cd ${COMFYUI_WORK_DIR}"
  alias cdmodels="cd ${COMFYUI_MODELS_DIR}"
  alias cdoutput="cd ${COMFYUI_OUTPUT_DIR}"

  # helpf - View environment documentation
  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/comfyui/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View ComfyUI environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "‚úó README.md not found at $README_FILE"
      return 1
    fi
  }
'''

zsh = '''
  # helper aliases
  alias cdwork="cd ${COMFYUI_WORK_DIR}"
  alias cdmodels="cd ${COMFYUI_MODELS_DIR}"
  alias cdoutput="cd ${COMFYUI_OUTPUT_DIR}"

  # helpf - View environment documentation
  helpf() {
    local README_FILE="$FLOX_ENV_PROJECT/README.md"
    local README_URL="https://raw.githubusercontent.com/barstoolbluz/floxenvs/main/comfyui/README.md"

    if [ "$1" = "--help" ]; then
      echo "Usage: helpf [OPTIONS]"
      echo ""
      echo "View ComfyUI environment documentation"
      echo ""
      echo "Options:"
      echo "  --force    Force download fresh copy from GitHub"
      echo "  --help     Show this help message"
      echo ""
      echo "The README is cached locally and only downloaded if missing."
      return 0
    fi

    if [ "$1" = "--force" ]; then
      echo "Fetching latest README.md from GitHub..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    elif [ ! -f "$README_FILE" ]; then
      echo "README.md not found, downloading..."
      if curl -fsSL "$README_URL" -o "$README_FILE"; then
        echo "‚úì Downloaded README.md"
      else
        echo "‚úó Failed to download README.md"
        return 1
      fi
    fi

    if [ -f "$README_FILE" ]; then
      bat --style=auto --paging=always "$README_FILE"
    else
      echo "‚úó README.md not found at $README_FILE"
      return 1
    fi
  }
'''


[services]
[services.comfyui]
command = '''
  # auto-detect compute backend
  if python3 -c "import torch; exit(0 if torch.cuda.is_available() else 1)" 2>/dev/null; then
    echo "üöÄ CUDA detected - running with GPU acceleration"
    CPU_FLAG=""
  elif python3 -c "import torch; exit(0 if torch.backends.mps.is_available() else 1)" 2>/dev/null; then
    echo "üçé Metal (MPS) detected - running with Apple Silicon acceleration"
    CPU_FLAG=""
  else
    echo "üíª No GPU acceleration available - running in CPU mode"
    CPU_FLAG="--cpu"
  fi

  exec comfyui \
    --user-directory $COMFYUI_WORK_DIR \
    --database-url $COMFYUI_DATABASE_URL \
    --listen $COMFYUI_LISTEN \
    --port $COMFYUI_PORT \
    $CPU_FLAG \
    --extra-model-paths-config $FLOX_ENV_CACHE/extra_model_paths.yaml \
    --output-directory $COMFYUI_OUTPUT_DIR \
    --input-directory $COMFYUI_INPUT_DIR \
    --temp-directory $COMFYUI_TEMP_DIR
'''
is-daemon = true

[services.comfyui.shutdown]
command = "kill $FLOX_PROCESS_PID"


[include]
# environments = [
#     { dir = "../common" }
# ]
